# ðŸ† Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð² "ÐšÑ€Ð¸Ð¼Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð‘Ð»ÐµÑ„"

## ÐžÐ±Ð·Ð¾Ñ€

ÐŸÑ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð² Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ Ð´Ð»Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð½Ð° Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ….

## ðŸ—ï¸ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

### ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹

```mermaid
graph TB
    A[LeaderboardService] --> B[Leaderboard Model]
    A --> C[User Model]
    B --> D[MongoDB - leaderboard collection]
    C --> E[MongoDB - users collection]
    
    F[API Routes] --> A
    G[Automatic Updates] --> A
    H[Migration Script] --> B
```

### ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹

1. **ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ**: Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¸ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¹ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ `leaderboard`
2. **ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ**: ÐšÐ°Ð¶Ð´Ñ‹Ðµ 10 Ð¼Ð¸Ð½ÑƒÑ‚ ÑÐ»ÑƒÐ¶Ð±a Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð²ÑÐµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¸
3. **Fallback**: ÐŸÑ€Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ ÐºÑÑˆÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ðº `users`
4. **Ð˜Ð½Ð´ÐµÐºÑÑ‹**: ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

## ðŸ“Š Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…

### ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ñ `leaderboard`

```javascript
{
  userId: String,           // ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Telegram
  username: String,         // ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÐ¼Ð¾Ðµ Ð¸Ð¼Ñ
  firstName: String,        // Ð˜Ð¼Ñ
  lastName: String,         // Ð¤Ð°Ð¼Ð¸Ð»Ð¸Ñ
  nickname: String,         // ÐÐ¸ÐºÐ½ÐµÐ¹Ð¼
  score: Number,            // ÐžÐ±Ñ‰Ð¸Ð¹ ÑÑ‡ÐµÑ‚
  rank: Number,             // ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ Ð² Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ðµ
  userRank: String,         // Ð—Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ°
  period: String,           // 'day', 'week', 'month', 'all'
  investigations: Number,   // ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ€Ð°ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ð¹
  accuracy: Number,         // Ð¢Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð² %
  winStreak: Number,        // Ð¢ÐµÐºÑƒÑ‰Ð°Ñ ÑÐµÑ€Ð¸Ñ Ð¿Ð¾Ð±ÐµÐ´
  lastGameDate: Date,       // Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð¸Ð³Ñ€Ñ‹
  updatedAt: Date          // Ð’Ñ€ÐµÐ¼Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÑÑˆÐ°
}
```

### Ð˜Ð½Ð´ÐµÐºÑÑ‹

```javascript
// ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¸Ð½Ð´ÐµÐºÑ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð°
{ period: 1, score: -1, rank: 1 }

// ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ðµ
{ period: 1, userId: 1 }

// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð¿Ð¸ÑÐµÐ¹
{ updatedAt: 1 }

// Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹
{ userId: 1 }
{ period: 1 }
```

## ðŸ”§ API Ð­Ð½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹

### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹

#### `GET /api/leaderboard/:period`
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° Ð´Ð»Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°.

**ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹:**
- `period`: `day` | `week` | `month` | `all`
- `limit`: ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 20)

**ÐžÑ‚Ð²ÐµÑ‚:**
```javascript
{
  "status": "success",
  "data": {
    "leaderboard": [
      {
        "rank": 1,
        "isCurrentUser": false,
        "name": "Ð˜Ð³Ñ€Ð¾Ðº123",
        "score": 1500,
        "userRank": "Ð”Ð•Ð¢Ð•ÐšÐ¢Ð˜Ð’"
      }
    ],
    "currentUser": {
      "rank": 42,
      "isCurrentUser": true,
      "name": "Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ð¸Ð³Ñ€Ð¾Ðº",
      "score": 750,
      "userRank": "ÐÐžÐ’Ð˜Ð§ÐžÐš"
    },
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 20
    },
    "meta": {
      "period": "all",
      "cached": true,
      "fallback": false,
      "updatedAt": "2023-12-01T10:30:00Z"
    }
  }
}
```

#### `GET /api/leaderboard/status`
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐ»ÑƒÐ¶Ð±Ñ‹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð².

**ÐžÑ‚Ð²ÐµÑ‚:**
```javascript
{
  "status": "success",
  "data": {
    "isRunning": true,
    "isUpdating": false,
    "lastUpdateTime": "2023-12-01T10:30:00Z",
    "updateIntervalMs": 600000,
    "nextUpdateIn": 450000,
    "cacheStats": {
      "all": 156,
      "day": 45,
      "week": 89,
      "month": 134
    }
  }
}
```

### ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹

#### `POST /api/leaderboard/force-update`
ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð².

**Ð¢ÐµÐ»Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:**
```javascript
{
  "period": "all"  // Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð´Ð»Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°
}
```

#### `DELETE /api/leaderboard/cache`
ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ° Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð².

**ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°:**
- `period`: Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)

#### `GET /api/leaderboard/user/:userId`
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð²Ð¾ Ð²ÑÐµÑ… Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð°Ñ….

## ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ

### 1. ÐŸÐµÑ€Ð²Ð¾Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ñ

```bash
# ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
npm run migrate-leaderboard
```

### 2. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

Ð¡Ð»ÑƒÐ¶Ð±Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:

```javascript
// Ð’ src/index.js
leaderboardService.start();
```

### 3. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐ»ÑƒÐ¶Ð±Ñ‹:

```bash
curl GET /api/leaderboard/status
```

## âš¡ ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

### Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

| ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ñ | Ð¡Ñ‚Ð°Ñ€Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° | ÐÐ¾Ð²Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° | Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ðµ |
|----------|----------------|---------------|-----------|
| ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð¿-20 | ~50ms | ~5ms | **10x** |
| ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ° | ~100ms | ~2ms | **50x** |
| Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´ | ~200ms | ~5ms | **40x** |

### ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸

1. **Ð¡Ð¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹**: Ð£ÑÐºÐ¾Ñ€ÑÑŽÑ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð½Ð° Ð¿Ð¾Ñ€ÑÐ´ÐºÐ¸
2. **Lean queries**: Ð­ÐºÐ¾Ð½Ð¾Ð¼ÑÑ‚ Ð¿Ð°Ð¼ÑÑ‚ÑŒ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ñ…
3. **Batch operations**: Ð­Ñ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¼Ð°ÑÑÐ¾Ð²Ñ‹Ðµ Ð²ÑÑ‚Ð°Ð²ÐºÐ¸
4. **ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ**: Ð¡Ð½Ð¸Ð¶Ð°ÐµÑ‚ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸

## ðŸ”„ Ð¡Ð»ÑƒÐ¶Ð±Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

### LeaderboardService

ÐšÐ»Ð°ÑÑ-ÑÐ¸Ð½Ð³Ð»Ñ‚Ð¾Ð½, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð².

#### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹

```javascript
// Ð—Ð°Ð¿ÑƒÑÐº ÑÐ»ÑƒÐ¶Ð±Ñ‹
leaderboardService.start();

// ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ»ÑƒÐ¶Ð±Ñ‹
leaderboardService.stop();

// ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
await leaderboardService.updateLeaderboards();

// ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð° Ñ fallback
const result = await leaderboardService.getLeaderboard('all', 20, userId);

// Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ»ÑƒÐ¶Ð±Ñ‹
const status = leaderboardService.getStatus();
```

#### ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹

- **Ð˜Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ**: 10 Ð¼Ð¸Ð½ÑƒÑ‚ (600,000 Ð¼Ñ)
- **ÐÐ²Ñ‚Ð¾ÑÑ‚Ð°Ñ€Ñ‚**: ÐŸÑ€Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ Ðº MongoDB
- **Graceful shutdown**: ÐŸÑ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ SIGTERM/SIGINT

## ðŸ“‹ Periods (ÐŸÐµÑ€Ð¸Ð¾Ð´Ñ‹)

### Ð¢Ð¸Ð¿Ñ‹ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¾Ð²

1. **`all`** - Ð’ÑÐµ Ð²Ñ€ÐµÐ¼Ñ
   - Ð’ÑÐµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð±ÐµÐ· Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ

2. **`month`** - ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¼ÐµÑÑÑ†
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ñ `lastVisit >= (now - 30 Ð´Ð½ÐµÐ¹)`

3. **`week`** - ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð½ÐµÐ´ÐµÐ»Ñ
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ñ `lastVisit >= (now - 7 Ð´Ð½ÐµÐ¹)`

4. **`day`** - ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð´ÐµÐ½ÑŒ
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ñ `lastVisit >= (now - 1 Ð´ÐµÐ½ÑŒ)`

### Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸

```javascript
const getDateFilter = (period) => {
  const now = new Date();
  switch (period) {
    case 'day':
      return { lastVisit: { $gte: new Date(now - 24*60*60*1000) } };
    case 'week':
      return { lastVisit: { $gte: new Date(now - 7*24*60*60*1000) } };
    case 'month':
      return { lastVisit: { $gte: new Date(now - 30*24*60*60*1000) } };
    default:
      return {}; // all time
  }
};
```

## ðŸ› ï¸ ÐžÐ±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ

### ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…

ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ ÑÑ‚Ð°Ñ€ÑˆÐµ 1 Ð´Ð½Ñ:

```javascript
await Leaderboard.cleanupOldEntries();
```

### ÐŸÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²

```javascript
const { createIndexes } = require('./src/utils/migrateLeaderboard');
await createIndexes();
```

### ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸

```bash
# Ð’ MongoDB shell
db.leaderboard.stats()
db.leaderboard.count()
```

## ðŸ› ÐžÑ‚Ð»Ð°Ð´ÐºÐ°

### Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

Ð’ÑÐµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ Ñ ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°:

- ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÐ»ÑƒÐ¶Ð±
- ðŸ”„ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
- âŒ ÐžÑˆÐ¸Ð±ÐºÐ¸
- ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
- ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ

```javascript
// Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ»ÑƒÐ¶Ð±Ñ‹
const status = leaderboardService.getStatus();
console.log('Ð¡Ð»ÑƒÐ¶Ð±Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:', status.isRunning);
console.log('ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:', status.lastUpdateTime);

// Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÑÑˆÐ°
const stats = await Promise.all([
  Leaderboard.countDocuments({ period: 'all' }),
  Leaderboard.countDocuments({ period: 'week' }),
  Leaderboard.countDocuments({ period: 'month' }),
  Leaderboard.countDocuments({ period: 'day' })
]);
console.log('Ð—Ð°Ð¿Ð¸ÑÐµÐ¹ Ð² ÐºÑÑˆÐµ:', stats);
```

## ðŸ” Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ

### ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ

Ð’ÑÐµ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚Ñ‹ Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ñ‹ middleware `authMiddleware`.

### ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸

- ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
- ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ°
- ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°

Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ñ€Ð¾Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°.

## ðŸ“ˆ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

### ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸

1. **Ð’Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°** Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð²
2. **Ð§Ð°ÑÑ‚Ð¾Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹** ÐºÑÑˆÐ°
3. **Ð Ð°Ð·Ð¼ÐµÑ€ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸** leaderboard
4. **Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²**

### Health check

```javascript
app.get('/api/health/leaderboard', async (req, res) => {
  const status = leaderboardService.getStatus();
  const isHealthy = status.isRunning && 
    (Date.now() - status.lastUpdateTime?.getTime()) < 15 * 60 * 1000; // 15 Ð¼Ð¸Ð½ÑƒÑ‚
  
  res.status(isHealthy ? 200 : 503).json({
    healthy: isHealthy,
    status
  });
});
```

---

## ðŸ”® ÐŸÐ»Ð°Ð½Ñ‹ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ

1. **Redis ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ** Ð´Ð»Ñ ÐµÑ‰Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµÐ¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
2. **Ð ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ** Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· WebSockets
3. **Ð“ÐµÐ¾Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¸** Ð¿Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð°Ð¼/Ñ€ÐµÐ³Ð¸Ð¾Ð½Ð°Ð¼
4. **ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¸** Ð´Ñ€ÑƒÐ·ÐµÐ¹
5. **Ð/B Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ** Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð¾Ð² Ñ€Ð°Ð½Ð¶Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ 